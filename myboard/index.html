<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🔥 게시판</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
  <style>
    /* 기본 레이아웃 */
    body { font-family: 'Noto Sans KR', sans-serif; background: #1e1e1e; color: #e5e7eb; max-width: 100%; margin: auto; padding: 10px; }
    .topbar { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 10px; }
    .card { background: #2d2d2d; border-radius: 12px; padding: 20px; box-shadow: 0 4px 14px rgba(0,0,0,0.2); margin-bottom: 20px; }
    input, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #555; border-radius: 8px; background: #1e1e1e; color: #e5e7eb; }
    button { background: #4f46e5; color: white; padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    button:hover { background: #6366f1; }

    /* 글 목록 */
    .post-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #444; }
    .post-item .title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 1em; }
    .post-item .comment-count { font-size: 0.8em; margin-left: 4px; background: #444; padding: 2px 6px; border-radius: 12px; vertical-align: super; }
    .post-item .meta { display: flex; align-items: center; gap: 8px; color: #aaa; margin-left: 10px; }
    .post-item .meta .author { font-size: 0.6em; }
    .post-item .meta .post-date { font-size: 0.6em; }
    .post-item .meta .views { font-size: 0.5em; }

    /* 상세창 메타 숨김 */
    .detail .card p { display: none; }

    /* 중앙 정렬 */
    .centered { display: flex; justify-content: center; margin-top: 10px; }
    .post-actions { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
    .comment-section { display: flex; flex-direction: column; align-items: center; margin-top: 10px; }
    .comment-section ul { list-style: none; padding: 0; width: 100%; }
    .comment-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }

    /* 반응형 모바일 */
    @media (max-width: 600px) {
      .post-item .title { font-size: 1em; }
      .post-item .meta .author, .post-item .meta .post-date { font-size: 0.5em; }
      .post-item .meta .views { font-size: 0.4em; }
      .post-actions, .comment-section { justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <p id="user">로그인 상태 확인 중...</p>
    <button id="login">로그인</button>
    <button id="logout" style="display:none">로그아웃</button>
  </div>

  <h1>🔥 Firebase 게시판</h1>
  <div id="postList"></div>
  <div id="pagination"></div>

  <form id="postForm" style="display:none" class="card">
    <input name="title" placeholder="제목 입력" required>
    <textarea name="content" rows="4" placeholder="내용 입력" required></textarea>
    <input type="file" name="files" multiple>
    <div class="uploading" id="uploadStatus" style="display:none;">업로드 중...</div>
    <div class="centered"><button type="submit">글 작성</button></div>
  </form>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, getDoc, getDocs, updateDoc, deleteDoc, serverTimestamp, orderBy, query, increment } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";

    const firebaseConfig = { apiKey: "...", authDomain: "...", projectId: "...", storageBucket: "...", messagingSenderId: "...", appId: "..." };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let currentUser = null, allPosts = [], currentPage = 1, perPage = 20, lastOpenedDetail = null;
    const ADMIN_EMAIL = 'castirian@gmail.com';

    // 인증 상태 처리
    const loginBtn = document.getElementById('login');
    const logoutBtn = document.getElementById('logout');
    onAuthStateChanged(auth, user => {
      currentUser = user;
      document.getElementById('user').textContent = user ? `👤 ${user.displayName}` : '로그인 필요';
      loginBtn.style.display = user ? 'none' : 'inline-block';
      logoutBtn.style.display = user ? 'inline-block' : 'none';
      document.getElementById('postForm').style.display = user ? 'block' : 'none';
    });
    loginBtn.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
    logoutBtn.onclick = () => signOut(auth);

    // 글 작성
    document.getElementById('postForm').onsubmit = async e => {
      e.preventDefault();
      document.getElementById('uploadStatus').style.display = 'block';
      try {
        const { title, content } = e.target;
        const files = e.target.files.files;
        const attachments = [];
        for (const f of files) {
          const storageRef = ref(storage, `uploads/${Date.now()}-${f.name}`);
          const snap = await uploadBytes(storageRef, f);
          attachments.push({ name: f.name, url: await getDownloadURL(snap.ref) });
        }
        await addDoc(collection(db, 'posts'), {
          title: title.value,
          content: content.value,
          uid: currentUser.uid,
          username: currentUser.displayName,
          photoURL: currentUser.photoURL,
          attachments,
          likes: 0,
          views: 0,
          createdAt: serverTimestamp()
        });
        e.target.reset();
        await loadPosts();
      } catch (err) {
        console.error(err);
        alert('글 작성 중 오류 발생');
      } finally {
        document.getElementById('uploadStatus').style.display = 'none';
      }
    };

    // 게시글 로드
    async function loadPosts() {
      const snap = await getDocs(query(collection(db, 'posts'), orderBy('createdAt', 'desc')));
      allPosts = [];
      for (const d of snap.docs) {
        const data = { id: d.id, ...d.data() };
        const comments = await getDocs(collection(db, 'posts', d.id, 'comments'));
        data.commentCount = comments.size;
        allPosts.push(data);
      }
      renderPage(1);
    }

    // 페이지 렌더링
    function renderPage(page) {
      currentPage = page;
      const list = document.getElementById('postList');
      list.innerHTML = '';
      const start = (page - 1) * perPage;
      allPosts.slice(start, start + perPage).forEach(p => {
        const dateStr = p.createdAt?.toDate().toLocaleString('en-US', {
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit', hour12: true
        });
        const div = document.createElement('div');
        div.className = 'post-item';
        div.onclick = () => toggleDetail(div, p.id);
        div.innerHTML = `
          <div class="title">${p.title}<span class="comment-count">${p.commentCount}</span></div>
          <div class="meta"><span class="author">${p.username}</span><span class="post-date">${dateStr}</span><span class="views">${p.views || 0}</span></div>
          <div class="detail" style="display:none"></div>
        `;
        list.appendChild(div);
      });
      const pg = document.getElementById('pagination');
      pg.innerHTML = '';
      const total = Math.ceil(allPosts.length / perPage);
      for (let i = 1; i <= total; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === page) btn.classList.add('active');
        btn.onclick = () => renderPage(i);
        pg.appendChild(btn);
      }
    }

    // 상세 보기
    async function toggleDetail(wrapper, id) {
      const detailDiv = wrapper.querySelector('.detail');
      if (lastOpenedDetail && lastOpenedDetail !== detailDiv) {
        lastOpenedDetail.style.display = 'none';
        lastOpenedDetail.innerHTML = '';
      }
      if (detailDiv.style.display === 'block') {
        detailDiv.style.display = 'none';
        detailDiv.innerHTML = '';
        lastOpenedDetail = null;
        return;
      }
      await updateDoc(doc(db, 'posts', id), { views: increment(1) });
      const snap = await getDoc(doc(db, 'posts', id));
      const p = snap.data();
      const dateStr = p.createdAt?.toDate().toLocaleString('en-US', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', hour12: true
      });
      const embedded = [];
      const contentHtml = p.content.replace(/https:\/\/(www\.)?youtube\.com\/watch\?v=([\w-]+)/g,
        (m, _, vid) => {
          embedded.push(`<iframe height="315" src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe>`);
          return m;
        });
      const filesHtml = p.attachments?.map(f => f.name.match(/\.(jpe?g|png|gif)$/i)
        ? `<img src="${f.url}" class="uploaded-img">`
        : f.name.match(/\.(mp4|webm)$/i)
          ? `<video src="${f.url}" controls></video>`
          : `<a href="${f.url}" target="_blank">📎 ${f.name}</a>`
      ).join('') || '';
      const isOwner = currentUser && (currentUser.uid === p.uid || currentUser.email === ADMIN_EMAIL);
      detailDiv.innerHTML = `
        <div class="card" onclick="event.stopPropagation()">
          <h3 id="post-title-${id}">${p.title}</h3>
          <p id="post-content-${id}">${contentHtml}</p>
          ${embedded.join('')}
          ${filesHtml}
          <div class="post-actions">
            ${isOwner ? `<button onclick="event.stopPropagation(); editPost('${id}')">✏️ 수정</button><button onclick="event.stopPropagation(); deletePost('${id}')">🗑️ 삭제</button>` : ''}
            <button onclick="event.stopPropagation(); likePost('${id}')">👍 (<span id="like-count-${id}">${p.likes || 0}</span>)</button>
          </div>
          <div class="comment-section">
            <input id="comment-input-${id}" type="text" placeholder="댓글 달기">
            <button onclick="event.stopPropagation(); addComment('${id}')">댓글 작성</button>
            <ul id="comment-list-${id}"></ul>
          </div>
        </div>
      `;
      loadComments(id);
      detailDiv.style.display = 'block';
      lastOpenedDetail = detailDiv;
    }

    window.editPost = async id=>{ const t=document.getElementById(`post-title-${id}`); const c=document.getElementById(`post-content-${id}`); const nt=prompt('제목 수정',t.textContent); const nc=prompt('내용 수정',c.textContent); if(nt&&nc){ await updateDoc(doc(db,'posts',id),{title:nt,content:nc}); t.textContent=nt; c.textContent=nc;} };
    window.likePost = async id=>{ await updateDoc(doc(db,'posts',id),{likes:increment(1)}); const e=document.getElementById(`like-count-${id}`); if(e) e.textContent=parseInt(e.textContent||'0')+1; };
    window.addComment = async id=>{ const i=document.getElementById(`comment-input-${id}`); if(!i.value.trim()) return; await addDoc(collection(db,'posts',id,'comments'),{text:i.value,author:currentUser.displayName,uid:currentUser.uid,createdAt:serverTimestamp()}); i.value=''; loadComments(id); };
    window.deleteComment = async(id,cid)=>{ if(!confirm('댓글을 삭제합니까?')) return; await deleteDoc(doc(db,'posts',id,'comments',cid)); loadComments(id);};
    window.deletePost = async id=>{ if(!confirm('삭제 합니까?')) return; await deleteDoc(doc(db,'posts',id)); loadPosts(); };

    async function loadComments(pid){ const ul=document.getElementById(`comment-list-${pid}`); ul.innerHTML=''; const snap=await getDocs(query(collection(db,'posts',pid,'comments'),orderBy('createdAt'))); snap.forEach(d=>{ const {author,text,uid}=d.data(); const li=document.createElement('li'); li.className='comment-item'; const sp=document.createElement('span'); sp.textContent=`${author}: ${text}`; li.appendChild(sp); if(currentUser&&(currentUser.email===ADMIN_EMAIL||currentUser.uid===uid)){ const bt=document.createElement('button'); bt.textContent='🗑️'; bt.onclick=e=>{e.stopPropagation();window.deleteComment(pid,d.id)}; li.appendChild(bt);} ul.appendChild(li); });}

    loadPosts();
  </script>
</body>
</html>
