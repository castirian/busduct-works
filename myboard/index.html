<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”¥ ê²Œì‹œíŒ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #1e1e1e;
      color: #e5e7eb;
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    .topbar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .card {
      background: #2d2d2d;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.2);
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #555;
      border-radius: 8px;
      background: #1e1e1e;
      color: #e5e7eb;
    }
    .post-item {
      padding: 12px 0;
      border-bottom: 1px solid #444;
    }
    .post-item .title {
      flex: 1;
      font-size: 1rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .post-item .comment-count {
      font-size: 0.6em;
      margin-left: 6px;
      background: #444;
      padding: 1px 4px;
      border-radius: 12px;
    }
    .post-item .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75em;
      color: #aaa;
      margin-top: 4px;
    }
    .post-item .footer .author,
    .post-item .footer .datetime {
      line-height: 1;
    }
    .pagination button.active {
      background: #6366f1;
      cursor: default;
      opacity: 0.8;
    }
    img.uploaded-img, video, iframe {
      width: 100%;
      margin-top: 10px;
    }
    /* ëª©ë¡ ë¯¸ë¦¬ë³´ê¸° 2ì¤„ */
    .content-preview {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
      margin: 8px 0;
    }
    /* ìƒì„¸ ë³¸ë¬¸ ì „ì²´ ì¤„ë°”ê¿ˆ ë³´ì¡´ */
    .post-content {
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      word-break: break-all;
      margin: 8px 0;
    }

    /* ëŒ“ê¸€ ì„¹ì…˜ */
    .comment-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 10px;
    }
    .comment-section ul {
      list-style: none;
      padding: 0;
      width: 100%;
    }
    .comment-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
    }

    /* ê³µí†µ ì•¡ì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .action-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 120px;
  height: 44px;
  padding: 0 16px;
  border-radius: 9999px;                             /* pill í˜•íƒœ */
  background: linear-gradient(135deg, #667eea, #764ba2); /* ê·¸ë¼ë””ì–¸íŠ¸ */
  color: #fff;
  font-weight: 600;
  font-size: 1rem;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1), 
              0 1px 3px rgba(0,0,0,0.08);             /* ê·¸ë¦¼ì */
  transition: transform 0.15s ease, box-shadow 0.15s ease;
  margin: 4px 0;
}
.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 10px rgba(0,0,0,0.12), 
              0 2px 4px rgba(0,0,0,0.10);
}
.action-btn:active {
  transform: translateY(0);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1), 
              0 1px 3px rgba(0,0,0,0.08);
}

/* ì•„ì´ì½˜ ì‚¬ìš© ì‹œ ê°„ê²© */
.action-btn svg {
  margin-right: 8px;
  width: 1em;
  height: 1em;
  vertical-align: middle;
}

    .action-btn > *:not(:last-child) {
      margin-right: 6px;
    }
    .post-actions {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 10px;
    }
    .centered {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }
    .uploading {
      text-align: center;
      color: #facc15;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <p id="user">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘...</p>
    <button id="login" class="action-btn">ë¡œê·¸ì¸</button>
    <button id="logout" class="action-btn" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <h1>ğŸ”¥ Firebase ê²Œì‹œíŒ</h1>
  <div id="postList"></div>
  <div id="pagination" class="pagination centered"></div>

  <form id="postForm" class="card" style="display:none">
    <input name="title" placeholder="ì œëª© ì…ë ¥" required>
    <textarea name="content" rows="4" placeholder="ë‚´ìš© ì…ë ¥" required></textarea>
    <input type="file" name="files" multiple>
    <div id="uploadStatus" class="uploading" style="display:none;">ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...</div>
    <div class="centered">
      <button type="submit" class="action-btn">ê¸€ ì‘ì„±</button>
    </div>
  </form>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, serverTimestamp, orderBy, query, limit, startAfter, increment, getCountFromServer } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";

    // Firebase ì„¤ì • ë³µì›
    const firebaseConfig = {
      apiKey: "AIzaSyC6RvL8x2EQrgy8aSc8R63fzRvg85fX32w",
      authDomain: "my-board-project-58b71.firebaseapp.com",
      projectId: "my-board-project-58b71",
      storageBucket: "my-board-project-58b71.firebasestorage.app",
      messagingSenderId: "720342019721",
      appId: "1:720342019721:web:910184dbb03e4451b1e058"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let currentUser = null, lastOpenedDetail = null, likeLock = false, commentLock = false;
    let pageCursors = {}, currentPage = 1;
    const perPage = 12;

    document.getElementById('login').onclick  = () => signInWithPopup(auth, new GoogleAuthProvider());
    document.getElementById('logout').onclick = () => signOut(auth);
    onAuthStateChanged(auth, user => {
      currentUser = user;
      document.getElementById('user').textContent = user ? `ğŸ‘¤ ${user.displayName}` : 'ë¡œê·¸ì¸ í•„ìš”';
      document.getElementById('login').style.display  = user ? 'none' : 'inline-flex';
      document.getElementById('logout').style.display = user ? 'inline-flex' : 'none';
      document.getElementById('postForm').style.display = user ? 'block' : 'none';
      loadPosts(1);
    });

    // ê¸€ ì‘ì„±
    document.getElementById('postForm').onsubmit = async e => {
      e.preventDefault();
      document.getElementById('uploadStatus').style.display = 'block';
      try {
        const title = e.target.title.value;
        const content = e.target.content.value;
        const files = e.target.files.files;
        const attachments = [];
        for (const f of files) {
          const r = ref(storage, `uploads/${Date.now()}-${f.name}`);
          const s = await uploadBytes(r, f);
          attachments.push({ name: f.name, url: await getDownloadURL(s.ref) });
        }
        await addDoc(collection(db, 'posts'), {
          title, content,
          uid: currentUser.uid,
          username: currentUser.displayName,
          photoURL: currentUser.photoURL,
          attachments,
          likes: 0,
          views: 0,
          createdAt: serverTimestamp()
        });
        e.target.reset();
        loadPosts(1);
      } catch {
        alert('ì˜¤ë¥˜ ë°œìƒ');
      } finally {
        document.getElementById('uploadStatus').style.display = 'none';
      }
    };

    async function getTotalPosts() {
      const countSnap = await getCountFromServer(collection(db, 'posts'));
      return countSnap.data().count;
}

function renderPagination(currentPage, totalPosts) {
  const totalPages  = Math.ceil(totalPosts / perPage);
  const windowSize  = 4;
  const windowStart = Math.floor((currentPage - 1) / windowSize) * windowSize + 1;
  const windowEnd   = Math.min(windowStart + windowSize - 1, totalPages);

  const pg = document.getElementById('pagination');
  pg.innerHTML = '';

  // â—€ ì´ì „ ë¸”ëŸ­
  if (windowStart > 1) {
    const b = document.createElement('button');
    b.textContent = '<';
    b.onclick = () => loadPosts(windowStart - 1);
    pg.appendChild(b);
  }

  // ìˆ«ì ë²„íŠ¼
  for (let i = windowStart; i <= windowEnd; i++) {
    const b = document.createElement('button');
    b.textContent = i;
    if (i === currentPage) b.classList.add('active');
    b.onclick = () => loadPosts(i);
    pg.appendChild(b);
  }

  // â–¶ ë‹¤ìŒ ë¸”ëŸ­
  if (windowEnd < totalPages) {
    const next = document.createElement('button');
    next.textContent = '>';
    next.onclick = () => loadPosts(windowEnd + 1);
    pg.appendChild(next);
  }
}

    // ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ (í˜ì´ì§€ë„¤ì´ì…˜)
    async function loadPosts(page = 1) {
  currentPage = page;            // í˜¸ì¶œëœ í˜ì´ì§€ë¥¼ ê¸°ë¡
  const list = document.getElementById('postList');
  list.innerHTML = '';

  let snap;
  if (page === 1) {
    // ì²« í˜ì´ì§€: ë‹¨ìˆœ limit
    snap = await getDocs(query(
      collection(db, 'posts'),
      orderBy('createdAt', 'desc'),
      limit(perPage)
    ));
  }  else {
    // ì´ì „ í˜ì´ì§€ cursor
    const cursor = pageCursors[page - 1];
    console.log(`Loading page ${page}, using cursor:`, cursor);
    if (!cursor) {
      // ì´ì „ í˜ì´ì§€ í•œ ë²ˆ ì±„ì›Œì¤˜ì•¼ ë‹¤ìŒ ì»¤ì„œê°€ ì„¤ì •ë©ë‹ˆë‹¤.
      await loadPosts(page - 1);
    }
    const lastDoc = pageCursors[page - 1];
    snap = await getDocs(query(
      collection(db, 'posts'),
      orderBy('createdAt', 'desc'),
      startAfter(lastDoc),
      limit(perPage)
    ));
  }

  // ì´ í˜ì´ì§€ì˜ ë§ˆì§€ë§‰ ë¬¸ì„œë¥¼ ì»¤ì„œë¡œ ì €ì¥
  if (snap.docs.length) {
    pageCursors[page] = snap.docs[snap.docs.length - 1];
  }

  // ë Œë”ë§
  for (const d of snap.docs) {
    const p = d.data();
    const comSnap = await getDocs(collection(db, 'posts', d.id, 'comments'));
    const commentCount = comSnap.size;
     const dateStr = p.createdAt?.toDate().toLocaleString('en-US', {
   year:   '2-digit',   // 2025 â†’ 25
   month:  '2-digit',
   day:    '2-digit',
   hour:   '2-digit',
   minute: '2-digit',
   hour12: true         // AM/PM
 }).replace(',', '');    // â€œMM/DD/YY, hh:mm AMâ€ â†’ â€œMM/DD/YY hh:mm AMâ€
    const div = document.createElement('div');
    div.className = 'post-item';
    div.onclick = () => toggleDetail(div, d.id);
     div.innerHTML = `
     <div class="header">
       <div class="title">${p.title}<span class="comment-count">${commentCount}</span></div>
     </div>

     <div class="content-preview">${p.content.slice(0,100)}</div>

     <div class="footer">
       <div class="info">
         <span class="author">${p.username}</span> Â·
         <span class="datetime">${dateStr}</span>
       </div>
       <div class="views">ğŸ‘ ${p.views ?? 0}</div>
     </div>


  <div class="detail" style="display:none"></div>
 `;
    list.appendChild(div);
  }

  // ì „ì²´ ê°œìˆ˜ ì§‘ê³„ë¡œ í˜ì´ì§• ë²„íŠ¼
  const totalPosts = await getCountFromServer(collection(db, 'posts')).then(s => s.data().count);
  renderPagination(page, totalPosts);
}

// ê²Œì‹œê¸€ ìƒì„¸ í•˜ë‹¨ ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadComments(postId) {
    const listEl = document.getElementById(`comment-list-${postId}`);
    if (!listEl) return;
    listEl.innerHTML = '';

    // ëŒ“ê¸€ ì»¬ë ‰ì…˜ì—ì„œ createdAt ìˆœ ì •ë ¬ í›„ ë¶ˆëŸ¬ì˜¤ê¸°
    const q = query(
      collection(db, 'posts', postId, 'comments'),
      orderBy('createdAt')
    );
    const snapshot = await getDocs(q);
    snapshot.forEach(docC => {
      const data = docC.data();
      const li = document.createElement('li');
      li.className = 'comment-item';
      li.innerHTML = `<span>${data.author}: ${data.text}</span>`;
      listEl.appendChild(li);
    });
  }
  // inline onclick ë“±ì—ì„œ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ ì „ì—­ì— ë…¸ì¶œ
  window.loadComments = loadComments;


    // ìƒì„¸ ë³´ê¸°
     async function toggleDetail(wrapper, id) {
   const detail = wrapper.querySelector('.detail');
   // â‘  ì´ì „ ìƒì„¸ì°½ì´ ìˆìœ¼ë©´ ë‹«ì•„ì¤€ë‹¤
   if (lastOpenedDetail && lastOpenedDetail !== detail) {
     lastOpenedDetail.style.display = 'none';
   }
      if (detail.style.display === 'block') {
        detail.style.display = 'none';
        return;
      }
  const refDoc = doc(db, 'posts', id);

  // 1) ì›ë³¸ ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°
  const snap = await getDoc(refDoc);
  const p    = snap.data();            // â‘  ì—¬ê¸°ë¡œ ì´ë™
  // 2) ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì•„ì§ ì•ˆ ë³¸ ê¸€ì¸ì§€ ì²´í¬
  if (currentUser) {
    const viewRef = doc(db, 'posts', id, 'views', currentUser.uid);
    const viewSnap = await getDoc(viewRef);
    if (!viewSnap.exists()) {
      await setDoc(viewRef, { uid: currentUser.uid, createdAt: serverTimestamp() });
      await updateDoc(refDoc, { views: increment(1) });
      // í™”ë©´ì—ì„œë„ ë°˜ì˜
      p.views = (p.views || 0) + 1;      // â‘¡ ì´ì œ ì—ëŸ¬ ì—†ì´ ë™ì‘
    }
  }
      
      const dateStr = p.createdAt?.toDate().toLocaleString();
      const embedded = [];
      const contentHtml = p.content.replace(
        /https:\/\/(www\.)?youtube\.com\/watch\?v=([\w-]+)/g,
        (m, _, vid) => {
          embedded.push(`<iframe loading="lazy" src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe>`);
          return m;
        }
      );
      const filesHtml = (p.attachments || [])
        .map(f => f.name.match(/\.(jpe?g|png|gif)$/i)
          ? `<img src="${f.url}" class="uploaded-img" loading="lazy">`
          : `<video src="${f.url}" controls loading="lazy"></video>`
        ).join('');
      const isOwner = currentUser && (currentUser.uid === p.uid);

      detail.innerHTML = `
  <div class="card" onclick="event.stopPropagation()">
     <h3
      id="post-title-${id}"
      style="display: none;"    /* í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹ë‹ˆë‹¤ */
    >${p.title}</h3>
       <div
     id="post-content-${id}"
     class="post-content"
   >${p.content}</div>
    ${embedded.join('')}
    ${filesHtml}
    <div class="post-actions">
      ${isOwner ? `
        <button
          id="edit-btn-${id}"
          onclick="event.stopPropagation(); editPost('${id}')"
        >âœï¸ ìˆ˜ì •</button>
        <button
          id="delete-btn-${id}"
          onclick="event.stopPropagation(); deletePost('${id}')"
        >ğŸ—‘ï¸ ì‚­ì œ</button>
      ` : ``}
      <button
        id="like-btn-${id}"
        onclick="event.stopPropagation(); likePost('${id}')"
      >
        ğŸ‘ (<span id="like-count-${id}">${p.likes ?? 0}</span>)
      </button>
    </div>
    <div class="comment-section">
      <input
        id="comment-input-${id}"
        type="text"
        placeholder="ëŒ“ê¸€ ë‹¬ê¸°"
      >
      <button
        id="comment-btn-${id}"
        onclick="event.stopPropagation(); addComment('${id}')"
      >ëŒ“ê¸€ ì‘ì„±</button>
      <ul id="comment-list-${id}"></ul>
    </div>
  </div>
`;
detail.style.display = 'block';
loadComments(id);
// â‘¡ ì§€ê¸ˆ ì—° ìƒì„¸ì°½ì„ ì €ì¥í•´ ë‘”ë‹¤
lastOpenedDetail = detail;
    }

// ìˆ˜ì • ê¸°ëŠ¥ (ì œëª©+ë‚´ìš©)
async function editPost(id) {
   // 1) ì¤‘ë³µ ë°©ì§€
   if (document.getElementById(`edit-form-${id}`)) return;
  const titleEl   = document.getElementById(`post-title-${id}`);
  const contentEl = document.getElementById(`post-content-${id}`);

  // 1) ê¸°ì¡´ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
  titleEl.style.display   = 'none';
  contentEl.style.display = 'none';

  // 2) í¸ì§‘ìš© í¼ ì»¨í…Œì´ë„ˆ ìƒì„±
  const editDiv = document.createElement('div');
  editDiv.id = `edit-form-${id}`;   // â† ì´ ì¤„ ì¶”ê°€
  editDiv.innerHTML = `
    <input id="edit-title-${id}" type="text" value="${titleEl.textContent}" style="width:100%;margin-bottom:6px;padding:4px;" />
    <textarea id="edit-content-${id}" rows="6" style="width:100%;padding:4px;">${contentEl.textContent}</textarea>
    <div style="text-align:right;margin-top:6px;">
      <button id="save-btn-${id}">ì €ì¥</button>
      <button id="cancel-btn-${id}">ì·¨ì†Œ</button>
    </div>
  `;
  // insert after contentEl
  contentEl.parentNode.insertBefore(editDiv, contentEl.nextSibling);

  // 3) ì·¨ì†Œ ë²„íŠ¼ í•¸ë“¤ëŸ¬
  document.getElementById(`cancel-btn-${id}`).onclick = () => {
    editDiv.remove();
    titleEl.style.display   = '';
    contentEl.style.display = '';
  };

  // 4) ì €ì¥ ë²„íŠ¼ í•¸ë“¤ëŸ¬
  document.getElementById(`save-btn-${id}`).onclick = async () => {
    const newTitle   = document.getElementById(`edit-title-${id}`).value;
    const newContent = document.getElementById(`edit-content-${id}`).value;
    // Firestore ì—…ë°ì´íŠ¸
    await updateDoc(doc(db,'posts',id), {
      title:   newTitle,
      content: newContent
    });
    // í™”ë©´ ë°˜ì˜ ë° ì •ë¦¬
    titleEl.textContent   = newTitle;
    contentEl.textContent = newContent;
    // ìˆ˜ì • í›„ ë°”ë¡œ ëª©ë¡ì— ë°˜ì˜
   loadPosts(currentPage);
    editDiv.remove();
    titleEl.style.display   = '';
    contentEl.style.display = '';
  };
}

// ì¢‹ì•„ìš” 1íšŒ ì œí•œ
async function likePost(id) {
const btn = document.querySelector(`#like-btn-${id}`); // â† ìˆ˜ì •
if (!currentUser) { alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.'); return; }
if (likeLock) return;
likeLock = true;
btn.disabled = true;  // â† ì¶”ê°€

const likeRef = doc(db, 'posts', id, 'likes', currentUser.uid);
const likeSnap = await getDoc(likeRef);
if (likeSnap.exists()) {
 alert('ì´ë¯¸ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì…¨ìŠµë‹ˆë‹¤.');
 likeLock = false;
 btn.disabled = false; // â† ì‹¤íŒ¨ ì‹œ í•´ì œ
 return;
}

await setDoc(likeRef, { uid: currentUser.uid, createdAt: serverTimestamp() });
await updateDoc(doc(db, 'posts', id), { likes: increment(1) });
const e = document.getElementById(`like-count-${id}`);
if (e) e.textContent = parseInt(e.textContent || '0') + 1;

setTimeout(() => {
 likeLock = false;
 btn.disabled = false;
}, 1000);
}

// ëŒ“ê¸€ ì“°ê¸°
async function addComment(id) {
const btn = document.querySelector(`#comment-btn-${id}`); // ë²„íŠ¼ id í™•ì¸
if (commentLock) return;
commentLock = true;
btn.disabled = true;  // ì¶”ê°€

const i = document.getElementById(`comment-input-${id}`);
if (!i.value.trim()) {
 commentLock = false;
 btn.disabled = false; // ì¶”ê°€
 return;
}

await addDoc(collection(db,'posts',id,'comments'), {
 text: i.value,
 author: currentUser.displayName,
 uid: currentUser.uid,
 createdAt: serverTimestamp()
});
i.value = '';
loadComments(id);

setTimeout(() => {
 commentLock = false;
 btn.disabled = false;
}, 1000);
}

// ëŒ“ê¸€ ì‚­ì œ
async function deleteComment(pid, cid) {
  if (!confirm('ëŒ“ê¸€ ì‚­ì œ?')) return;
  await deleteDoc(doc(db,'posts',pid,'comments',cid));
  loadComments(pid);
}

// ê¸€ ì‚­ì œ
async function deletePost(id) {
  if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  await deleteDoc(doc(db,'posts',id));
  loadPosts(1);
}

// ì „ì—­ ë…¸ì¶œ
window.editPost      = editPost;
window.likePost      = likePost;
window.addComment    = addComment;
window.deleteComment = deleteComment;
window.deletePost    = deletePost;

    
  </script>
</body>
</html>
