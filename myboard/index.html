<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🔥 게시판</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background: #1e1e1e; color: #e5e7eb; max-width: 800px; margin: auto; padding: 20px; }
    .topbar { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 10px; }
    .card { background: #2d2d2d; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 14px rgba(0,0,0,0.2); }
    input, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #555; border-radius: 8px; background: #1e1e1e; color: #e5e7eb; }
    button { background: #4f46e5; color: white; padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    button:hover { background: #6366f1; }
    .post-item { padding: 12px 0; border-bottom: 1px solid #444; }
    .post-item .title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .post-item .comment-count { font-size: 0.6em; margin-left: 6px; background: #444; padding: 1px 4px; border-radius: 12px; }
    .post-item .meta { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; margin-left: 10px; color: #aaa; }
    .centered { display: flex; justify-content: center; margin-top: 10px; }
    .uploading { text-align: center; color: #facc15; margin-bottom: 10px; }
    .pagination button.active { background: #6366f1; cursor: default; opacity: 0.8; }
    img.uploaded-img, video, iframe { width: 100%; margin-top: 10px; }
    .post-actions { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
    .comment-section { margin-top: 10px; }
    .comment-item { display: flex; justify-content: space-between; padding: 4px 0; }
  </style>
  <link rel="icon" href="favicon.ico" />
</head>
<body>
  <div class="topbar">
    <p id="user">로그인 상태 확인 중...</p>
    <button id="login">로그인</button>
    <button id="logout" style="display:none">로그아웃</button>
  </div>
  <h1>🔥 Firebase Board 🔥</h1>
  <div id="postList"></div>
  <div id="pagination" class="pagination"></div>
  <form id="postForm" style="display:none" class="card">
    <input name="title" placeholder="제목 입력" required>
    <textarea name="content" rows="4" placeholder="내용 입력" required></textarea>
    <input type="file" name="files" multiple>
    <div class="uploading" id="uploadStatus" style="display:none;">업로드 중입니다...</div>
    <div class="centered"><button type="submit">글 작성</button></div>
  </form>

  <script type="module">
    let lastOpenedDetail = null; 
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, serverTimestamp, orderBy, query, limit, increment } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC6RvL8x2EQrgy8aSc8R63fzRvg85fX32w",
      authDomain: "my-board-project-58b71.firebaseapp.com",
      projectId: "my-board-project-58b71",
      storageBucket: "my-board-project-58b71.firebasestorage.app",
      messagingSenderId: "720342019721",
      appId: "1:720342019721:web:910184dbb03e4451b1e058"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let currentUser = null;
    const perPage = 20;

    document.getElementById('login').onclick  = () => signInWithPopup(auth, new GoogleAuthProvider());
    document.getElementById('logout').onclick = () => signOut(auth);
    onAuthStateChanged(auth, user => {
      currentUser = user;
      document.getElementById('user').textContent = user ? `👤 ${user.displayName}` : '로그인 필요';
      document.getElementById('login').style.display  = user ? 'none' : 'inline-block';
      document.getElementById('logout').style.display = user ? 'inline-block' : 'none';
      document.getElementById('postForm').style.display = user ? 'block' : 'none';
         // 로그인 전·후 구분 없이 항상 게시글 목록을 불러옵니다
      loadPosts(1);
    });

    // 글 작성
    document.getElementById('postForm').onsubmit = async e => {
      e.preventDefault();
      document.getElementById('uploadStatus').style.display = 'block';
      try {
        const title = e.target.title.value;
        const content = e.target.content.value;
        const files = e.target.files.files;
        const attachments = [];
        for (const f of files) {
          const r = ref(storage, `uploads/${Date.now()}-${f.name}`);
          const s = await uploadBytes(r, f);
          attachments.push({ name: f.name, url: await getDownloadURL(s.ref) });
        }
        // photoURL 포함
        await addDoc(collection(db, 'posts'), {
          title, content,
          uid: currentUser.uid,
          username: currentUser.displayName,
          photoURL: currentUser.photoURL,
          attachments,
          likes: 0,
          views: 0,
          commentCount: 0,
          createdAt: serverTimestamp()
        });
        e.target.reset();
        loadPosts(1);
      } catch (err) {
        console.error(err);
        alert('오류 발생');
      } finally {
        document.getElementById('uploadStatus').style.display = 'none';
      }
    };

    // 게시글 리스트 (페이지네이션)
    async function loadPosts(page = 1) {
      const list = document.getElementById('postList');
      list.innerHTML = '';
      const snap = await getDocs(query(
        collection(db, 'posts'),
        orderBy('createdAt', 'desc'),
        limit(perPage)
      ));
      for (const d of snap.docs) {
        const p = d.data();
                // ① 실제 댓글 개수 구하기
        const comSnap = await getDocs(collection(db, 'posts', d.id, 'comments'));
        const commentCount = comSnap.size;        
        const dateStr = p.createdAt?.toDate().toLocaleString();
        const div = document.createElement('div');
        div.className = 'post-item';
        div.onclick = () => toggleDetail(div, d.id);
        div.innerHTML = `
          <div class="title">
            ${p.title}
            <span class="comment-count">${p.commentCount ?? 0}</span>
          </div>
          <div class="meta">
            <span class="author">${p.username}</span>
            <span class="post-date">${dateStr}</span>
            <span class="views">${p.views}</span>
          </div>
          <div class="detail" style="display:none"></div>
        `;
        list.appendChild(div);
      }
      renderPagination(page);
    }

// 게시글 상세 하단 댓글 불러오기
async function loadComments(postId) {
    const listEl = document.getElementById(`comment-list-${postId}`);
    if (!listEl) return;
    listEl.innerHTML = '';

    // 댓글 컬렉션에서 createdAt 순 정렬 후 불러오기
    const q = query(
      collection(db, 'posts', postId, 'comments'),
      orderBy('createdAt')
    );
    const snapshot = await getDocs(q);
    snapshot.forEach(docC => {
      const data = docC.data();
      const li = document.createElement('li');
      li.className = 'comment-item';
      li.innerHTML = `<span>${data.author}: ${data.text}</span>`;
      listEl.appendChild(li);
    });
  }
  // inline onclick 등에서 참조할 수 있도록 전역에 노출
  window.loadComments = loadComments;

    function renderPagination(currentPage) {
      const total = Math.ceil(/* 전체 게시물 수 구하는 로직 */ 100 / perPage);
      const pg = document.getElementById('pagination');
      pg.innerHTML = '';
      for (let i = 1; i <= total; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === currentPage) btn.classList.add('active');
        btn.onclick = () => loadPosts(i);
        pg.appendChild(btn);
      }
    }

    // 상세 보기
     async function toggleDetail(wrapper, id) {
   const detail = wrapper.querySelector('.detail');
   // ① 이전 상세창이 있으면 닫아준다
   if (lastOpenedDetail && lastOpenedDetail !== detail) {
     lastOpenedDetail.style.display = 'none';
   }
      if (detail.style.display === 'block') {
        detail.style.display = 'none';
        return;
      }
      const refDoc = doc(db, 'posts', id);
      const [snap] = await Promise.all([
        getDoc(refDoc),
        updateDoc(refDoc, { views: increment(1) })
      ]);
      const p = snap.data();
      const dateStr = p.createdAt?.toDate().toLocaleString();
      const embedded = [];
      const contentHtml = p.content.replace(
        /https:\/\/(www\.)?youtube\.com\/watch\?v=([\w-]+)/g,
        (m, _, vid) => {
          embedded.push(`<iframe loading="lazy" src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe>`);
          return m;
        }
      );
      const filesHtml = (p.attachments || [])
        .map(f => f.name.match(/\.(jpe?g|png|gif)$/i)
          ? `<img src="${f.url}" class="uploaded-img" loading="lazy">`
          : `<video src="${f.url}" controls loading="lazy"></video>`
        ).join('');
      const isOwner = currentUser && (currentUser.uid === p.uid);

      detail.innerHTML = `
        <div class="card" onclick="event.stopPropagation()">
          <h3 id="post-title-${id}">${p.title}</h3>
          <div id="post-content-${id}">${p.content}</div>
          ${embedded.join('')}
          ${filesHtml}
          <div class="post-actions">
            ${isOwner ? `<button onclick="event.stopPropagation(); editPost('${id}')">✏️ 수정</button>
                          <button onclick="event.stopPropagation(); deletePost('${id}')">🗑️ 삭제</button>` : ''}
            <button onclick="event.stopPropagation(); likePost('${id}')">👍 (<span id="like-count-${id}">${p.likes ?? 0}</span>)</button>
          </div>
          <div class="comment-section">
            <input id="comment-input-${id}" type="text" placeholder="댓글 달기">
            <button onclick="event.stopPropagation(); addComment('${id}')">댓글 작성</button>
            <ul id="comment-list-${id}"></ul>
          </div>
        </div>`;
      detail.style.display = 'block';
      loadComments(id);
         // ② 지금 연 상세창을 저장해 둔다
        lastOpenedDetail = detail;
    }

// 수정 기능 (제목+내용)
async function editPost(id) {
  const titleEl   = document.getElementById(`post-title-${id}`);
  const contentEl = document.getElementById(`post-content-${id}`);
  const newTitle   = prompt('제목 수정', titleEl.textContent);
  const newContent = prompt('내용 수정', contentEl.textContent);
  if (newTitle === null || newContent === null) return;
  await updateDoc(doc(db,'posts',id), { title: newTitle, content: newContent });
  titleEl.textContent   = newTitle;
  contentEl.textContent = newContent;
}

// 좋아요 1회 제한
async function likePost(id) {
  if (!currentUser) { alert('로그인 후 이용해주세요.'); return; }
  const likeRef = doc(db, 'posts', id, 'likes', currentUser.uid);
  const likeSnap = await getDoc(likeRef);
  if (likeSnap.exists()) { alert('이미 좋아요를 누르셨습니다.'); return; }
  await setDoc(likeRef, { uid: currentUser.uid, createdAt: serverTimestamp() });
  await updateDoc(doc(db, 'posts', id), { likes: increment(1) });
  const e = document.getElementById(`like-count-${id}`);
  if (e) e.textContent = parseInt(e.textContent||'0')+1;
}

// 댓글 쓰기
async function addComment(id) {
  const i = document.getElementById(`comment-input-${id}`);
  if (!i.value.trim()) return;
  await addDoc(collection(db,'posts',id,'comments'), {
    text: i.value,
    author: currentUser.displayName,
    uid: currentUser.uid,
    createdAt: serverTimestamp()
  });
  i.value = '';
  loadComments(id);
}

// 댓글 삭제
async function deleteComment(pid, cid) {
  if (!confirm('댓글 삭제?')) return;
  await deleteDoc(doc(db,'posts',pid,'comments',cid));
  loadComments(pid);
}

// 글 삭제
async function deletePost(id) {
  if (!confirm('삭제하시겠습니까?')) return;
  await deleteDoc(doc(db,'posts',id));
  loadPosts(1);
}

// 전역 노출
window.editPost      = editPost;
window.likePost      = likePost;
window.addComment    = addComment;
window.deleteComment = deleteComment;
window.deletePost    = deletePost;

    loadPosts(1);
  </script>
</body>
</html>
